(function(e){"use strict";function i(e,t){for(var n in t){if(t.hasOwnProperty(n)){e[n]=t[n]}}return e}function s(e){var t=[],n=e.length,r=e[0].length;for(var i=0;i<n;i++){t=t.concat(e[i])}t=o(t);var s=[],u=0;for(var a=0;a<n;a++){var f=[];for(var l=0;l<r;l++){f.push(t[u]);u++}s.push(f)}return s}function o(e){var t=e.length,n,r;while(t){r=Math.floor(Math.random()*t--);n=e[t];e[t]=e[r];e[r]=n}return e}function u(e,t){this.el=e;this.inner=this.el.querySelector("div");this.allItems=[].slice.call(this.inner.children);this.allItemsCount=this.allItems.length;if(!this.allItemsCount)return;this.items=[].slice.call(this.inner.querySelectorAll("figure:not([data-dummy])"));this.itemsCount=this.items.length;this.current=0;this.options=i({},this.options);i(this.options,t);this._init()}Modernizr.addTest("csstransformspreserve3d",function(){var t=Modernizr.prefixed("transformStyle");var n="preserve-3d";var r;if(!t)return false;t=t.replace(/([A-Z])/g,function(e,t){return"-"+t.toLowerCase()}).replace(/^ms-/,"-ms-");Modernizr.testStyles("#modernizr{"+t+":"+n+";}",function(n,i){r=e.getComputedStyle?getComputedStyle(n,null).getPropertyValue(t):""});return r===n});var t={transitions:Modernizr.csstransitions,preserve3d:Modernizr.csstransformspreserve3d},n={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"},r=n[Modernizr.prefixed("transition")];u.prototype.options={};u.prototype._init=function(){this.currentItem=this.items[this.current];this._addNavigation();this._getSizes();this._initEvents()};u.prototype._addNavigation=function(){this.nav=document.createElement("nav");var e="";for(var t=0;t<this.itemsCount;++t){e+="<span></span>"}this.nav.innerHTML=e;this.el.appendChild(this.nav);this.navDots=[].slice.call(this.nav.children)};u.prototype._initEvents=function(){var n=this,r=classie.hasClass(this.el,"photostack-start"),i=function(){var e=function(){if(t.transitions){classie.addClass(n.el,"photostack-transition")}};if(r){this.removeEventListener("click",i);classie.removeClass(n.el,"photostack-start");e()}else{n.openDefault=true;setTimeout(e,25)}n.started=true;n._showPhoto(n.current)};if(r){this._shuffle();this.el.addEventListener("click",i)}else{i()}this.navDots.forEach(function(e,t){e.addEventListener("click",function(){if(t===n.current){n._rotateItem()}else{var e=function(){n._showPhoto(t)};if(n.flipped){n._rotateItem(e)}else{e()}}})});e.addEventListener("resize",function(){n._resizeHandler()})};u.prototype._resizeHandler=function(){function t(){e._resize();e._resizeTimeout=null}var e=this;if(this._resizeTimeout){clearTimeout(this._resizeTimeout)}this._resizeTimeout=setTimeout(t,100)};u.prototype._resize=function(){var e=this,t=function(){e._shuffle(true)};this._getSizes();if(this.started&&this.flipped){this._rotateItem(t)}else{t()}};u.prototype._showPhoto=function(e){if(this.isShuffling){return false}this.isShuffling=true;if(classie.hasClass(this.currentItem,"photostack-flip")){this._removeItemPerspective();classie.removeClass(this.navDots[this.current],"flippable")}classie.removeClass(this.navDots[this.current],"current");classie.removeClass(this.currentItem,"photostack-current");this.current=e;this.currentItem=this.items[this.current];classie.addClass(this.navDots[this.current],"current");if(this.currentItem.querySelector(".photostack-back")){classie.addClass(this.navDots[e],"flippable")}this._shuffle()};u.prototype._shuffle=function(e){var n=e?1:this.currentItem.getAttribute("data-shuffle-iteration")||1;if(n<=0||!this.started||this.openDefault){n=1}if(this.openDefault){classie.addClass(this.currentItem,"photostack-flip");this.openDefault=false;this.isShuffling=false}var i=.5,o=Math.ceil(this.sizes.inner.width/(this.sizes.item.width*i)),u=Math.ceil(this.sizes.inner.height/(this.sizes.item.height*i)),a=o*this.sizes.item.width*i+this.sizes.item.width/2-this.sizes.inner.width,f=u*this.sizes.item.height*i+this.sizes.item.height/2-this.sizes.inner.height,l=a/2,c=f/2,h=35,p=-35,d=this,v=function(){--n;var e=[];for(var a=0;a<u;++a){var f=e[a]=[];for(var m=0;m<o;++m){var g=m*d.sizes.item.width*i-l,y=a*d.sizes.item.height*i-c,b=0,w=0;if(d.started&&n===0){var E=d._isOverlapping({x:g,y:y});if(E.overlapping){b=E.noOverlap.x;w=E.noOverlap.y;var S=Math.floor(Math.random()*3);switch(S){case 0:b=0;break;case 1:w=0;break}}}f[m]={x:g+b,y:y+w}}}e=s(e);var x=0,T=0,N=0;d.allItems.forEach(function(i,s){if(x===o-1){T=T===u-1?0:T+1;x=1}else{++x}var a=Math.floor(Math.random()*o),f=Math.floor(Math.random()*u),l=e[T][x-1],c={x:l.x,y:l.y},m=function(){++N;if(t.transitions){this.removeEventListener(r,m)}if(N===d.allItemsCount){if(n>0){v.call()}else{classie.addClass(d.currentItem,"photostack-flip");d.isShuffling=false;if(typeof d.options.callback==="function"){d.options.callback(d.currentItem)}}}};if(d.items.indexOf(i)===d.current&&d.started&&n===0){d.currentItem.style.WebkitTransform="translate("+d.centerItem.x+"px,"+d.centerItem.y+"px) rotate(0deg)";d.currentItem.style.msTransform="translate("+d.centerItem.x+"px,"+d.centerItem.y+"px) rotate(0deg)";d.currentItem.style.transform="translate("+d.centerItem.x+"px,"+d.centerItem.y+"px) rotate(0deg)";if(d.currentItem.querySelector(".photostack-back")){d._addItemPerspective()}classie.addClass(d.currentItem,"photostack-current")}else{i.style.WebkitTransform="translate("+c.x+"px,"+c.y+"px) rotate("+Math.floor(Math.random()*(h-p+1)+p)+"deg)";i.style.msTransform="translate("+c.x+"px,"+c.y+"px) rotate("+Math.floor(Math.random()*(h-p+1)+p)+"deg)";i.style.transform="translate("+c.x+"px,"+c.y+"px) rotate("+Math.floor(Math.random()*(h-p+1)+p)+"deg)"}if(d.started){if(t.transitions){i.addEventListener(r,m)}else{m()}}})};v.call()};u.prototype._getSizes=function(){this.sizes={inner:{width:this.inner.offsetWidth,height:this.inner.offsetHeight},item:{width:this.currentItem.offsetWidth,height:this.currentItem.offsetHeight}};this.centerItem={x:this.sizes.inner.width/2-this.sizes.item.width/2,y:this.sizes.inner.height/2-this.sizes.item.height/2}};u.prototype._isOverlapping=function(e){var t=this.sizes.item.width+this.sizes.item.width/3,n=this.sizes.item.height+this.sizes.item.height/3,r={x:this.sizes.inner.width/2-t/2,y:this.sizes.inner.height/2-n/2},i=this.sizes.item.width,s=this.sizes.item.height;if(!(e.x+i<r.x||e.x>r.x+t||e.y+s<r.y||e.y>r.y+n)){var o=Math.random()<.5,u=Math.floor(Math.random()*(i/4+1)),a=Math.floor(Math.random()*(s/4+1)),f=o?(e.x-r.x+i)*-1-u:r.x+t-(e.x+i)+i+u,l=o?(e.y-r.y+s)*-1-a:r.y+n-(e.y+s)+s+a;return{overlapping:true,noOverlap:{x:f,y:l}}}return{overlapping:false}};u.prototype._addItemPerspective=function(){classie.addClass(this.el,"photostack-perspective")};u.prototype._removeItemPerspective=function(){classie.removeClass(this.el,"photostack-perspective");classie.removeClass(this.currentItem,"photostack-flip")};u.prototype._rotateItem=function(e){if(classie.hasClass(this.el,"photostack-perspective")&&!this.isRotating&&!this.isShuffling){this.isRotating=true;var n=this,i=function(){if(t.transitions&&t.preserve3d){this.removeEventListener(r,i)}n.isRotating=false;if(typeof e==="function"){e()}};if(this.flipped){classie.removeClass(this.navDots[this.current],"flip");if(t.preserve3d){this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)";this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)"}else{classie.removeClass(this.currentItem,"photostack-showback")}}else{classie.addClass(this.navDots[this.current],"flip");if(t.preserve3d){this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)";this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)"}else{classie.addClass(this.currentItem,"photostack-showback")}}this.flipped=!this.flipped;if(t.transitions&&t.preserve3d){this.currentItem.addEventListener(r,i)}else{i()}}};e.Photostack=u})(window)